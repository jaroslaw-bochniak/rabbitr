onNode {
    stage('Checkout') {
        deleteDir()
        github url: 'git@github.com:smartrecruiters/rabbitr.git'
    }

    String projectPath = '/go/src/github.com/smartrecruiters/rabbitr'
    inDocker(image: 'sr-golang:3.1.4', srRegistry: true, params: "-v $WORKSPACE:$projectPath") {
        stage('Build & Release') {
            withCredentials([usernamePassword(credentialsId: 'approver-token', passwordVariable: 'GITHUB_TOKEN', usernameVariable: 'GITHUB_USERNAME')]) {
                sh 'git config user.email "core@smartrecruiters.com"'
                sh 'git config user.name "CoreTeam"'
                sh "cd $projectPath; make install; make release"
            }
        }
    }
}
